name: Build SukiSU-Ultra Kernel (4.19 SDM660 Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        repository: user-why-red/android_kernel_xiaomi_sdm660_419
        path: kernel_source
        fetch-depth: 1

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc curl git gnupg gperf imagemagick lib32readline-dev \
        lib32z1-dev liblz4-tool libsdl1.2-dev libssl-dev libwxgtk3.0-gtk3-dev libxml2 libxml2-utils \
        lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev libc6-dev-i386 \
        libncurses5-dev lib32ncurses5-dev python3 python2

    - name: Download Clang Toolchain (Proton-Clang 13)
      run: |
        mkdir -p clang
        cd clang
        # 4.19 内核配合 Proton-Clang 13 兼容性最好
        git clone --depth=1 https://github.com/kdrag0n/proton-clang.git -b master .
        cd ..

    - name: Integrate SukiSU-Ultra
      run: |
        cd kernel_source
        # 修复：明确指定分支，susfs-main 并不总是存在，建议使用 susfs-v1.5.5 或 nongki
        # 这里为你保留 susfs 功能
        curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-v1.5.5
        echo "SukiSU Source Integrated"

    - name: Configure Kernel
      run: |
        cd kernel_source
        
        # 修复：Defconfig 查找逻辑
        # 优先查找 lavender (Redmi Note 7) 的配置
        DEFCONFIG_NAME=""
        # 遍历可能的配置文件名
        for conf in "lavender_defconfig" "vendor/lavender_defconfig" "whyred_defconfig" "sdm660_defconfig"; do
            if [ -f "arch/arm64/configs/$conf" ]; then
                DEFCONFIG_NAME=$conf
                break
            fi
        done
        
        # 如果没找到，尝试模糊搜索
        if [ -z "$DEFCONFIG_NAME" ]; then
             echo "Specific config not found, searching specifically for lavender..."
             DEFCONFIG_NAME=$(find arch/arm64/configs -name "*lavender*defconfig" | head -n 1 | xargs basename)
        fi
        
        # 如果还是空的，报错退出，不要编译 gki_defconfig
        if [ -z "$DEFCONFIG_NAME" ]; then
            echo "Error: Could not find lavender_defconfig or whyred_defconfig!"
            exit 1
        fi

        echo "Using defconfig: $DEFCONFIG_NAME"

        # 设置环境变量
        export PATH=$(pwd)/../clang/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        export CC=clang
        # 修复：Proton Clang 使用 gnu- 前缀，不是 android-
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        # 生成 .config
        make O=out $DEFCONFIG_NAME

        # 修改 .config 以开启 SukiSU 必需的选项
        cd out
        ../scripts/config --file .config --enable CONFIG_KPM
        ../scripts/config --file .config --enable CONFIG_KALLSYMS
        ../scripts/config --file .config --enable CONFIG_KALLSYMS_ALL
        ../scripts/config --file .config --enable CONFIG_KPROBES
        ../scripts/config --file .config --enable CONFIG_HAVE_KPROBES
        ../scripts/config --file .config --enable CONFIG_MODULES
        ../scripts/config --file .config --enable CONFIG_MODULE_UNLOAD
        ../scripts/config --file .config --enable CONFIG_KPROBE_EVENTS
        ../scripts/config --file .config --enable CONFIG_KSU_MANUAL_HOOK
        ../scripts/config --file .config --enable CONFIG_OVERLAY_FS
        
        # 兼容性修复：禁用 LTO 以防止链接错误
        ../scripts/config --file .config --disable CONFIG_LTO_CLANG 
        ../scripts/config --file .config --disable CONFIG_LTO
        
        # 重新生成并检查
        make O=. olddefconfig
        cd ..

    - name: Build Kernel
      run: |
        cd kernel_source
        export PATH=$(pwd)/../clang/bin:$PATH
        
        # 修复：添加 LD=ld.lld 等参数强制使用 LLVM 工具，解决 gcc not found 问题
        make -j$(nproc) O=out \
             ARCH=arm64 \
             CC=clang \
             LD=ld.lld \
             AR=llvm-ar \
             NM=llvm-nm \
             OBJCOPY=llvm-objcopy \
             OBJDUMP=llvm-objdump \
             STRIP=llvm-strip \
             CROSS_COMPILE=aarch64-linux-gnu- \
             CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
             CLANG_TRIPLE=aarch64-linux-gnu- \
             Image.gz-dtb

    - name: Package with AnyKernel3
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
        
        # 复制编译好的镜像
        if [ -f kernel_source/out/arch/arm64/boot/Image.gz-dtb ]; then
            cp kernel_source/out/arch/arm64/boot/Image.gz-dtb ak3/
        else
            echo "Image.gz-dtb not found, checking for Image..."
            cp kernel_source/out/arch/arm64/boot/Image ak3/
        fi
        
        cd ak3
        # 这里的 device.name1=lavender 是为了确保刷机脚本识别设备
        # sed -i 's/device.name1=.*/device.name1=lavender/' anykernel.sh
        
        zip -r9 SukiSU-Ultra-Kernel-lavender-4.19.zip * -x .git README.md *placeholder
        mv SukiSU-Ultra-Kernel-lavender-4.19.zip ..

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SukiSU-Ultra-Kernel
        path: SukiSU-Ultra-Kernel-lavender-4.19.zip
